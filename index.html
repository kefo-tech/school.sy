<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>school.sy</title>

  <style>
    :root{
      --bg:#f6f9ff; --card:#fff; --text:#0b1220; --muted:#6b7280;
      --primary:#0ea5e9; --primary2:#2563eb; --danger:#ef4444;
      --ring: rgba(14,165,233,.25);
      --shadow: 0 18px 50px rgba(15,23,42,.12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma,Arial; background:linear-gradient(180deg,#eef6ff, #f8fbff 40%, #f6f9ff); color:var(--text)}
    a{color:inherit}
    .hidden{display:none!important}

    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.85); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(15,23,42,.06);
    }
    .topbar .wrap{
      max-width:1100px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900}
    .brand .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      display:grid;place-items:center;color:#fff;
      box-shadow:0 14px 30px rgba(37,99,235,.22);
      user-select:none;
    }
    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      appearance:none;border:0; cursor:pointer;
      padding:10px 14px; border-radius:14px;
      background:#fff; color:var(--text);
      border:1px solid rgba(15,23,42,.08);
      box-shadow: 0 10px 24px rgba(15,23,42,.08);
      font-weight:800;
      transition:.2s transform,.2s box-shadow,.2s border-color;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(14,165,233,.35); box-shadow:0 16px 36px rgba(15,23,42,.12)}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary2)); color:#fff; border-color:transparent}
    .btn.ghost{background:transparent; box-shadow:none}
    .pill{
      font-weight:900; padding:8px 12px; border-radius:999px;
      background:rgba(14,165,233,.12); color:#035b86;
      border:1px solid rgba(14,165,233,.18);
    }

    main{max-width:1100px;margin:0 auto;padding:20px 16px 60px}
    .hero{
      border-radius:var(--radius);
      background:
        linear-gradient(90deg, rgba(2,132,199,.86), rgba(37,99,235,.72)),
        url("https://images.unsplash.com/photo-1529070538774-1843cb3265df?auto=format&fit=crop&w=1400&q=70");
      background-size:cover; background-position:center;
      color:#fff; box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero .inner{padding:26px 22px; display:flex; align-items:flex-end; justify-content:space-between; gap:16px; flex-wrap:wrap}
    .hero h1{margin:0;font-size:34px; letter-spacing:.2px}
    .hero p{margin:8px 0 0; opacity:.95; font-weight:600}
    .hero .chips{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .hero .chip{
      background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.22);
      padding:8px 12px; border-radius:999px; font-weight:800;
    }

    .grid{display:grid; gap:14px}
    @media(min-width:900px){ .grid.cols2{grid-template-columns: 1.2fr .8fr} }
    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,.06);
      overflow:hidden;
    }
    .card .hd{padding:16px 16px 0}
    .card .hd h2{margin:0 0 6px; font-size:18px}
    .card .bd{padding:16px}
    .muted{color:var(--muted)}
    .small{font-size:13px}

    .filters{display:flex; gap:10px; flex-wrap:wrap}
    .input, select{
      width:100%; max-width: 360px;
      padding:12px 14px; border-radius:14px;
      border:1px solid rgba(15,23,42,.10);
      outline:none;
      background:#fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .input:focus, select:focus{border-color:rgba(14,165,233,.5); box-shadow:0 0 0 6px var(--ring)}
    .schools{display:grid; gap:12px}
    @media(min-width:760px){ .schools{grid-template-columns: repeat(2,minmax(0,1fr));} }
    @media(min-width:1050px){ .schools{grid-template-columns: repeat(3,minmax(0,1fr));} }

    .schoolCard{padding:14px; display:flex; flex-direction:column; gap:10px}
    .schoolCard .row{display:flex; align-items:center; gap:12px}
    .avatar{
      width:54px; height:54px; border-radius:18px;
      background:linear-gradient(135deg, rgba(14,165,233,.18), rgba(37,99,235,.12));
      border:1px solid rgba(14,165,233,.25);
      display:grid; place-items:center;
      font-weight:900; color:#075985;
      overflow:hidden;
      user-select:none;
    }
    .avatar img{width:100%; height:100%; object-fit:cover}
    .schoolCard h3{margin:0; font-size:16px}
    .schoolCard .actions{display:flex; gap:10px; flex-wrap:wrap}
    .tag{display:inline-flex; align-items:center; gap:8px; font-weight:800;
      padding:8px 10px; border-radius:999px; border:1px solid rgba(15,23,42,.08);
      background:rgba(2,132,199,.06);
    }

    .top3{display:grid; gap:12px}
    @media(min-width:760px){ .top3{grid-template-columns:repeat(3,minmax(0,1fr))} }
    .rankCard{padding:14px; display:flex; gap:12px; align-items:center; position:relative}
    .rankCard .badge{
      position:absolute; top:12px; left:12px;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff; font-weight:900;
      padding:8px 12px; border-radius:999px;
      box-shadow:0 12px 26px rgba(37,99,235,.22);
    }
    .rankMeta{min-width:0}
    .rankName{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .rankCount{color:var(--muted); font-size:13px; font-weight:700}

    .posts{display:grid; gap:12px}
    .post{padding:14px}
    .postHeader{display:flex; gap:10px; align-items:center}
    .postTitle{margin:0; font-size:16px}
    .postType{color:var(--muted); font-weight:800; font-size:12px}
    .bullets{margin:8px 0 0; padding:0 18px; color:#111827; font-weight:700}

    .footer{
      margin-top:22px; padding:14px 0; text-align:center; color:var(--muted); font-weight:700;
    }

    .modalOverlay{
      position:fixed; inset:0; background:rgba(2,6,23,.55);
      backdrop-filter: blur(6px);
      display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:1000;
    }
    .modal{
      width:min(560px,100%);
      background:#fff; border-radius:26px; box-shadow:0 30px 80px rgba(0,0,0,.25);
      border:1px solid rgba(15,23,42,.12);
      overflow:hidden;
    }
    .modal .mh{padding:16px 18px; border-bottom:1px solid rgba(15,23,42,.08); display:flex; align-items:center; justify-content:space-between}
    .modal .mh h3{margin:0; font-size:16px}
    .modal .mb{padding:16px 18px}
    .row2{display:grid; gap:10px}
    @media(min-width:720px){ .row2{grid-template-columns: 1fr 1fr} }
    .msg{margin-top:10px; font-weight:900}
    .msg.ok{color:#0f766e}
    .msg.err{color:#b91c1c}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo">S</div>
        <div>
          <div style="font-size:18px">school.sy</div>
          <div class="small muted" id="routeHint">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + ØµÙØ­Ø§Øª Ù…Ø¯Ø§Ø±Ø³ ØªÙØ§Ø¹Ù„ÙŠØ©</div>
        </div>
      </div>

      <div class="nav">
        <button class="btn ghost" id="btnHome">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</button>
        <span class="pill" id="userPill">Ø²Ø§Ø¦Ø±</span>
        <button class="btn" id="btnLoginOpen">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" id="btnLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>

  <main>
    <!-- HOME -->
    <section id="viewHome">
      <div class="hero">
        <div class="inner">
          <div>
            <h1>school.sy</h1>
            <p>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙÙŠ Ø³ÙˆØ±ÙŠØ§ + ØµÙØ­Ø§Øª Ù…Ø¯Ø§Ø±Ø³ ØªÙØ§Ø¹Ù„ÙŠØ© (ØªØµÙˆÙŠØª + Ù…Ù†Ø´ÙˆØ±Ø§Øª + Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª)</p>
            <div class="chips" style="margin-top:12px">
              <div class="chip">Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div>
              <div class="chip">ØµÙØ­Ø§Øª Ù…Ø¯Ø§Ø±Ø³</div>
              <div class="chip">ØªØµÙˆÙŠØª Ù„Ù„Ø·Ù„Ø§Ø¨</div>
              <div class="chip">Ù…Ù†Ø´ÙˆØ±Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©</div>
            </div>
          </div>
          <div style="text-align:left">
            <div class="small" style="opacity:.95;font-weight:800">Ù…Ù„Ø§Ø­Ø¸Ø©:</div>
            <div class="small" style="opacity:.9;max-width:320px">
              Ø§Ù„ØªØµÙˆÙŠØª Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¹Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.
            </div>
          </div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:14px">
        <div class="card">
          <div class="hd">
            <h2>ğŸ† Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Top 3)</h2>
            <div class="muted small">Ø­Ø³Ø¨ Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„ØªØµÙˆÙŠØª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (votesCount)</div>
          </div>
          <div class="bd">
            <div class="top3" id="topSchools"></div>
            <div class="small muted" id="topSchoolsHint" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</h2>
            <div class="muted small">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¯Ø§Ø±Ø³Ù‡Ø§</div>
          </div>
          <div class="bd">
            <div class="filters">
              <input class="input" id="qName" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©..." />
              <select id="qCity">
                <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>
              </select>
            </div>
            <div class="small muted" style="margin-top:10px">
              Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØ© â€œØ§Ù„Ø£Ù‚Ø±Ø¨â€ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ lat/lng Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³.
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="hd">
          <h2>ğŸ« Ù…Ø¯Ø§Ø±Ø³ Ø³ÙˆØ±ÙŠØ§</h2>
          <div class="muted small">Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¯Ø§Ø±Ø³ + ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© + Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„</div>
        </div>
        <div class="bd">
          <div class="schools" id="schoolsList"></div>
          <div class="small muted" id="schoolsHint" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="footer">Â© school.sy â€¢ ØªØ·ÙˆÙŠØ±: Zakaria KeFo</div>
    </section>

    <!-- SCHOOL -->
    <section id="viewSchool" class="hidden">
      <div class="hero" id="schoolHero">
        <div class="inner">
          <div>
            <h1 id="schoolTitle">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h1>
            <p id="schoolSubtitle">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© â€¢ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</p>
            <div class="chips" style="margin-top:12px">
              <div class="chip" id="chipCity">â€”</div>
              <div class="chip" id="chipVotes">0 ØªØµÙˆÙŠØª</div>
              <div class="chip" id="chipMap">ğŸ“ Ø®Ø±Ø§Ø¦Ø·</div>
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end">
            <button class="btn primary" id="btnRequestStudentParent">Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨ (Ø·Ø§Ù„Ø¨/ÙˆÙ„ÙŠ Ø£Ù…Ø±)</button>
            <button class="btn" id="btnBack">â¬…ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¯Ù„ÙŠÙ„</button>
          </div>
        </div>
      </div>

      <div class="grid cols2" style="margin-top:14px">
        <div class="card">
          <div class="hd">
            <h2>ğŸ‘¨â€ğŸ« Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Top 3)</h2>
            <div class="muted small">Ù…Ù† leaderboards/{schoolId}.teachersTop</div>
          </div>
          <div class="bd">
            <div class="top3" id="teachersTop"></div>
            <div class="small muted" id="teachersHint" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>ğŸ“ Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ (Top 3)</h2>
            <div class="muted small">Ù…Ù† leaderboards/{schoolId}.studentsTop</div>
          </div>
          <div class="bd">
            <div class="top3" id="studentsTop"></div>
            <div class="small muted" id="studentsHint" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="hd">
          <h2>ğŸ“Œ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
          <div class="muted small">Ù…Ù† collection: posts (Ù…Ø¹ schoolId)</div>
        </div>
        <div class="bd">
          <div class="posts" id="postsList"></div>
          <div class="small muted" id="postsHint" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="footer">Â© school.sy â€¢ ØªØ·ÙˆÙŠØ±: Zakaria KeFo</div>
    </section>
  </main>

  <!-- Login Modal -->
  <div class="modalOverlay hidden" id="loginModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¨ÙƒÙˆØ¯ KeFo)</h3>
        <button class="btn" id="btnLoginClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="mb">
        <div class="row2">
          <input class="input" id="loginCode" placeholder="KeFo12345" />
          <input class="input" id="loginPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button class="btn primary" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
          <span class="small muted">Ø­Ø³Ø§Ø¨ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØµÙˆÙŠØª).</span>
        </div>
        <div class="msg small" id="loginMsg"></div>
      </div>
    </div>
  </div>

  <!-- Request Account Modal -->
  <div class="modalOverlay hidden" id="reqModal">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="mh">
        <h3>Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨ (Ø·Ø§Ù„Ø¨ / ÙˆÙ„ÙŠ Ø£Ù…Ø±)</h3>
        <button class="btn" id="btnReqClose">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="mb">
        <div class="row2">
          <select id="reqRole">
            <option value="student">Ø·Ø§Ù„Ø¨</option>
            <option value="parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</option>
          </select>
          <input class="input" id="reqName" placeholder="Ø§Ù„Ø§Ø³Ù… (Ø£Ùˆ: Ø£Ù‡Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨)" />
        </div>
        <div class="row2" style="margin-top:10px">
          <input class="input" id="reqPhone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
          <input class="input" id="reqNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button class="btn primary" id="btnSendRequest">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
          <span class="small muted">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©.</span>
        </div>
        <div class="msg small" id="reqMsg"></div>
      </div>
    </div>
  </div>

  <!-- Ø­Ù…Ø§ÙŠØ© Ø¨Ø³ÙŠØ·Ø© -->
  <script>
    (function harden(){
      document.addEventListener("contextmenu", (e)=> e.preventDefault());
      document.addEventListener("copy", (e)=> { e.preventDefault(); });
      document.addEventListener("cut", (e)=> { e.preventDefault(); });
      document.addEventListener("dragstart", (e)=> e.preventDefault());
      document.addEventListener("selectstart", (e)=> e.preventDefault());
      document.addEventListener("keydown", (e)=>{
        const k = (e.key||"").toLowerCase();
        if ((e.ctrlKey || e.metaKey) && (k==="c" || k==="u" || k==="s" || k==="p" || k==="a")) e.preventDefault();
        if (e.key === "F12") e.preventDefault();
      });
    })();
  </script>

  <script type="module">
    const $ = (id) => document.getElementById(id);
    const show = (el) => el && el.classList.remove("hidden");
    const hide = (el) => el && el.classList.add("hidden");

    const views = { home: $("viewHome"), school: $("viewSchool") };
    function showView(name){
      Object.values(views).forEach(hide);
      show(views[name]);
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function slugify(ar){
      return encodeURIComponent(String(ar||"").trim().replace(/\s+/g,"-"));
    }
    function banner(msg, kind="err"){
      const box = document.createElement("div");
      box.style.cssText = `
        position:fixed;left:10px;right:10px;bottom:10px;z-index:99999;
        background:${kind==="ok" ? "#064e3b" : "#7f1d1d"};
        color:#fff;border:1px solid rgba(255,255,255,.15);
        border-radius:14px;padding:12px;font-family:system-ui;line-height:1.6;
        box-shadow:0 12px 30px rgba(0,0,0,.35); direction:rtl;
      `;
      box.innerHTML = msg;
      document.body.appendChild(box);
      setTimeout(()=> box.remove(), 4200);
    }

    /* Firebase */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc,
      addDoc, collection, serverTimestamp,
      query, where, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCexRHqxd8Xm_EBWMEnLj_2WAjxJcgXf9g",
      authDomain: "school-sy.firebaseapp.com",
      projectId: "school-sy",
      storageBucket: "school-sy.firebasestorage.app",
      messagingSenderId: "121186119852",
      appId: "1:121186119852:web:f96d12deade6cebbda6f09"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* Login UI */
    const loginModal = $("loginModal");
    $("btnLoginOpen").onclick = ()=> show(loginModal);
    $("btnLoginClose").onclick = ()=> hide(loginModal);
    $("btnLogout").onclick = async ()=> { try{ await signOut(auth); }catch{} };

    $("btnLogin").onclick = async ()=>{
      $("loginMsg").className = "msg small";
      $("loginMsg").textContent = "";
      const code = $("loginCode").value.trim();
      const pass = $("loginPass").value;

      if (!code.startsWith("KeFo")){
        $("loginMsg").className = "msg small err";
        $("loginMsg").textContent = "Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ KeFo";
        return;
      }
      if (!pass || pass.length < 6){
        $("loginMsg").className = "msg small err";
        $("loginMsg").textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø©";
        return;
      }

      const email = `${code}@school.local`;
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        $("loginMsg").className = "msg small ok";
        $("loginMsg").textContent = "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        hide(loginModal);
      }catch(e){
        $("loginMsg").className = "msg small err";
        $("loginMsg").textContent = "ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + (e?.message || e);
      }
    };

    /* Request UI */
    const reqModal = $("reqModal");
    $("btnReqClose").onclick = ()=> hide(reqModal);

    let currentSchoolId = null;
    $("btnRequestStudentParent").onclick = ()=>{
      if (!currentSchoolId) return;
      $("reqMsg").textContent = "";
      $("reqMsg").className = "msg small";
      $("reqRole").value = "student";
      $("reqName").value = "";
      $("reqPhone").value = "";
      $("reqNote").value = "";
      show(reqModal);
    };

    $("btnSendRequest").onclick = async ()=>{
      $("reqMsg").textContent = "";
      $("reqMsg").className = "msg small";

      if (!currentSchoolId){
        $("reqMsg").className = "msg small err";
        $("reqMsg").textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³Ø©.";
        return;
      }

      const role = $("reqRole").value;
      const name = $("reqName").value.trim();
      const phone = $("reqPhone").value.trim();
      const note = $("reqNote").value.trim();

      if (!name){
        $("reqMsg").className = "msg small err";
        $("reqMsg").textContent = "Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨";
        return;
      }

      try{
        await addDoc(collection(db, "account_requests"), {
          role,
          displayName: name,
          phone: phone || "",
          note: note || "",
          status: "pending",
          schoolId: currentSchoolId,
          createdAt: serverTimestamp()
        });
        $("reqMsg").className = "msg small ok";
        $("reqMsg").textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
      }catch(e){
        $("reqMsg").className = "msg small err";
        $("reqMsg").textContent = "Ø®Ø·Ø£: " + (e?.message || e);
      }
    };

    /* Auth state (optional) */
    let currentProfile = null;
    onAuthStateChanged(auth, async (user)=>{
      $("btnLogout").classList.toggle("hidden", !user);
      if (!user){
        currentProfile = null;
        $("userPill").textContent = "Ø²Ø§Ø¦Ø±";
        $("btnLoginOpen").classList.remove("hidden");
        return;
      }
      $("btnLoginOpen").classList.add("hidden");
      $("userPill").textContent = "Ù…Ø³ØªØ®Ø¯Ù…";

      try{
        const us = await getDoc(doc(db, "users", user.uid));
        if (us.exists()){
          currentProfile = us.data();
          const role = currentProfile?.role || "user";
          $("userPill").textContent = role === "student" ? "Ø·Ø§Ù„Ø¨" : (role === "parent" ? "ÙˆÙ„ÙŠ Ø£Ù…Ø±" : role);
        }
      }catch{}
    });

    /* Render helpers */
    function renderTop(container, arr){
      container.innerHTML = "";
      const safe = Array.isArray(arr) ? arr : [];
      for (let i=0;i<3;i++){
        const it = safe[i] || { displayName:"â€”", photoURL:"", count:0 };
        const card = document.createElement("div");
        card.className = "card rankCard";
        card.innerHTML = `
          <div class="badge">#${i+1}</div>
          <div class="avatar">${it.photoURL ? `<img src="${esc(it.photoURL)}" alt="">` : (esc(it.displayName)[0]||"ØŸ")}</div>
          <div class="rankMeta">
            <div class="rankName">${esc(it.displayName)}</div>
            <div class="rankCount">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµÙˆÙ‘ØªÙŠÙ†: ${Number(it.count||0)}</div>
          </div>
        `;
        container.appendChild(card);
      }
    }

    function renderSchoolsCards(list){
      const wrap = $("schoolsList");
      wrap.innerHTML = "";
      list.forEach((s)=>{
        const div = document.createElement("div");
        div.className = "card schoolCard";
        const letter = (s.name?.trim()?.[0] || "S");

        const mapsUrl = s.mapsUrl
          ? s.mapsUrl
          : (s.address
              ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address)}`
              : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((s.name||"")+" "+(s.city||""))}`);

        div.innerHTML = `
          <div class="row">
            <div class="avatar">${s.logoURL ? `<img src="${esc(s.logoURL)}" alt="">` : esc(letter)}</div>
            <div style="min-width:0">
              <h3 title="${esc(s.name)}">${esc(s.name || "â€”")}</h3>
              <div class="small muted">${esc(s.city || "â€”")} â€¢ ${esc(s.address || "â€”")}</div>
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <span class="tag">ğŸ—³ï¸ ${Number(s.votesCount||0)} ØªØµÙˆÙŠØª</span>
          </div>
          <div class="actions">
            <button class="btn primary" data-open="${esc(s.id)}" data-name="${esc(s.name||"")}">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</button>
            <a class="btn" href="${mapsUrl}" target="_blank" rel="noopener">Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„</a>
          </div>
        `;
        div.querySelector("[data-open]").onclick = (e)=>{
          const id = e.currentTarget.getAttribute("data-open");
          const name = e.currentTarget.getAttribute("data-name");
          location.hash = `#/school/${id}-${slugify(name)}`;
        };
        wrap.appendChild(div);
      });
    }

    /* Home: read schools (uses votesCount) */
    let allSchools = [];
    let citiesSet = new Set();
    let schoolsUnsub = null;

    function applyFilters(){
      const nameQ = $("qName").value.trim().toLowerCase();
      const cityQ = $("qCity").value;

      const filtered = allSchools.filter(s=>{
        const okName = !nameQ || (String(s.name||"").toLowerCase().includes(nameQ));
        const okCity = !cityQ || (String(s.city||"") === cityQ);
        return okName && okCity;
      });

      renderSchoolsCards(filtered);
      $("schoolsHint").textContent = filtered.length ? `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${filtered.length}` : "Ù„Ø§ Ù†ØªØ§Ø¦Ø¬. Ø¬Ø±Ù‘Ø¨ Ø¨Ø­Ø«Ù‹Ø§ Ù…Ø®ØªÙ„ÙÙ‹Ø§.";
    }

    $("qName").addEventListener("input", applyFilters);
    $("qCity").addEventListener("change", applyFilters);

    function watchSchools(){
      if (schoolsUnsub) schoolsUnsub();
      const q = query(collection(db, "schools"), orderBy("votesCount","desc"), limit(200));
      schoolsUnsub = onSnapshot(q, (snap)=>{
        allSchools = [];
        citiesSet = new Set();
        snap.forEach(d=>{
          const x = d.data() || {};
          allSchools.push({ id:d.id, ...x });
          if (x.city) citiesSet.add(x.city);
        });

        const sel = $("qCity");
        const prev = sel.value;
        sel.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>` + [...citiesSet].sort().map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
        if ([...citiesSet].includes(prev)) sel.value = prev;

        const top = allSchools.slice(0,3);
        const topWrap = $("topSchools");
        topWrap.innerHTML = "";
        top.forEach((s, idx)=>{
          const card = document.createElement("div");
          card.className = "card rankCard";
          card.innerHTML = `
            <div class="badge">#${idx+1}</div>
            <div class="avatar">${s.logoURL ? `<img src="${esc(s.logoURL)}" alt="">` : esc((s.name||"S")[0])}</div>
            <div class="rankMeta">
              <div class="rankName">${esc(s.name || "â€”")}</div>
              <div class="rankCount">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµÙˆÙ‘ØªÙŠÙ†: ${Number(s.votesCount||0)}</div>
            </div>
            <button class="btn primary" style="margin-right:auto" data-open="${esc(s.id)}" data-name="${esc(s.name||"")}">ÙØªØ­</button>
          `;
          card.querySelector("[data-open]").onclick = (e)=>{
            const id = e.currentTarget.getAttribute("data-open");
            const name = e.currentTarget.getAttribute("data-name");
            location.hash = `#/school/${id}-${slugify(name)}`;
          };
          topWrap.appendChild(card);
        });
        $("topSchoolsHint").textContent = top.length ? "ÙŠØªÙ… Ø§Ù„ÙØ±Ø² Ø­Ø³Ø¨ votesCount." : "Ø£Ø¶Ù Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ø®Ù„ collection: schools Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù‡Ù†Ø§.";

        applyFilters();
      }, (err)=>{
        banner("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ù…Ù† Firestore. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ collection Ø¨Ø§Ø³Ù… schools ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.", "err");
        console.error(err);
      });
    }

    /* School page watchers */
    let schoolUnsub = null;
    let postsUnsub  = null;
    let lbUnsub     = null;

    function stopSchoolWatchers(){
      if (schoolUnsub){ schoolUnsub(); schoolUnsub=null; }
      if (postsUnsub){ postsUnsub(); postsUnsub=null; }
      if (lbUnsub){ lbUnsub(); lbUnsub=null; }
    }

    function setSchoolHeroCover(url){
      const hero = $("schoolHero");
      const base = `
        linear-gradient(90deg, rgba(2,132,199,.86), rgba(37,99,235,.72)),
      `;
      const img = url
        ? `url("${url.replace(/"/g,'')}")`
        : `url("https://images.unsplash.com/photo-1529070538774-1843cb3265df?auto=format&fit=crop&w=1400&q=70")`;
      hero.style.backgroundImage = base + img;
      hero.style.backgroundSize = "cover";
      hero.style.backgroundPosition = "center";
    }

    function openSchool(schoolId){
      currentSchoolId = schoolId;
      $("routeHint").textContent = `ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${schoolId}`;
      showView("school");
      stopSchoolWatchers();

      // School doc
      schoolUnsub = onSnapshot(doc(db, "schools", schoolId), (snap)=>{
        if (!snap.exists()){
          banner("Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Firestore.", "err");
          return;
        }
        const s = snap.data() || {};
        $("schoolTitle").textContent = s.name || "Ù…Ø¯Ø±Ø³Ø©";
        $("schoolSubtitle").textContent = `${s.city || "â€”"} â€¢ ${s.address || "â€”"}`;
        $("chipCity").textContent = s.city || "â€”";
        $("chipVotes").textContent = `${Number(s.votesCount||0)} ØªØµÙˆÙŠØª`;

        setSchoolHeroCover(s.coverURL || "");

        const mapsUrl = s.mapsUrl
          ? s.mapsUrl
          : (s.address
              ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address)}`
              : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((s.name||"")+" "+(s.city||""))}`);
        $("chipMap").style.cursor = "pointer";
        $("chipMap").onclick = ()=> window.open(mapsUrl, "_blank", "noopener");
      }, (err)=>{
        banner("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ (allow read).", "err");
        console.error(err);
      });

      // Leaderboards doc: leaderboards/{schoolId}
      lbUnsub = onSnapshot(doc(db, "leaderboards", schoolId), (snap)=>{
        const data = snap.exists() ? (snap.data()||{}) : {};
        renderTop($("teachersTop"), data.teachersTop || []);
        renderTop($("studentsTop"), data.studentsTop || []);
        $("teachersHint").textContent = snap.exists()
          ? "ÙŠØªÙ… Ø¹Ø±Ø¶ teachersTop Ù…Ù† leaderboards."
          : "Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ leaderboards Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø¹Ø¯.";
        $("studentsHint").textContent = snap.exists()
          ? "ÙŠØªÙ… Ø¹Ø±Ø¶ studentsTop Ù…Ù† leaderboards."
          : "Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ leaderboards Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø¨Ø¹Ø¯.";
      }, (err)=>{
        console.error(err);
        banner("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© leaderboards. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯.", "err");
      });

      // Posts (may need index)
      const pq = query(
        collection(db, "posts"),
        where("schoolId","==",schoolId),
        orderBy("createdAt","desc"),
        limit(30)
      );

      postsUnsub = onSnapshot(pq, (snap)=>{
        const wrap = $("postsList");
        wrap.innerHTML = "";
        snap.forEach((d)=>{
          const p = d.data() || {};
          const div = document.createElement("div");
          div.className = "card post";

          const typeLabel = p.type === "mcq" ? "Ø§Ø®ØªØ¨Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯)" : "Ù…Ù†Ø´ÙˆØ±";
          let body = "";
          if (p.type === "mcq"){
            const opts = (p.mcq?.options || []).map(x=>`<li>${esc(x)}</li>`).join("");
            body = `
              <div class="muted small">Ø³Ø¤Ø§Ù„:</div>
              <div style="font-weight:900;margin:6px 0 8px">${esc(p.mcq?.question || "")}</div>
              <ul class="bullets">${opts}</ul>
            `;
          }else{
            body = `<div style="font-weight:700;line-height:1.8">${esc(p.content || "")}</div>`;
          }

          div.innerHTML = `
            <div class="postHeader">
              <div class="avatar" style="width:42px;height:42px">${p.authorPhoto ? `<img src="${esc(p.authorPhoto)}" alt="">` : (esc(p.authorName)[0]||"Ù…")}</div>
              <div style="min-width:0">
                <h3 class="postTitle">${esc(p.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†")}</h3>
                <div class="postType">${typeLabel} â€¢ ${esc(p.authorName || "Ù…Ø¹Ù„Ù…")}</div>
              </div>
            </div>
            <div style="margin-top:10px">${body}</div>
          `;
          wrap.appendChild(div);
        });

        $("postsHint").textContent = snap.size ? `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${snap.size}` : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.";
      }, (err)=>{
        console.error(err);
        $("postsHint").innerHTML = `âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª. ØºØ§Ù„Ø¨Ù‹Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Index Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù….<br>
        Ø§ÙØªØ­ Console ÙˆØ§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ Index Ù…Ù† Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­.`;
        banner("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (Ù‚Ø¯ ÙŠØ­ØªØ§Ø¬ Index).", "err");
      });
    }

    /* Router */
    function parseHash(){
      const h = (location.hash || "#/").replace(/^#/, "");
      const parts = h.split("/").filter(Boolean);
      if (!parts.length) return { page:"home" };
      if (parts[0]==="school" && parts[1]){
        const decoded = decodeURIComponent(parts[1]);
        const id = decoded.split("-")[0];
        return { page:"school", schoolId:id };
      }
      return { page:"home" };
    }

    function route(){
      const r = parseHash();
      if (r.page==="school" && r.schoolId){
        openSchool(r.schoolId);
      } else {
        currentSchoolId = null;
        $("routeHint").textContent = "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + ØµÙØ­Ø§Øª Ù…Ø¯Ø§Ø±Ø³ ØªÙØ§Ø¹Ù„ÙŠØ©";
        stopSchoolWatchers();
        showView("home");
      }
    }

    window.addEventListener("hashchange", route);
    $("btnHome").onclick = ()=> location.hash = "#/";
    $("btnBack").onclick = ()=> location.hash = "#/";

    /* Start */
    watchSchools();
    route();
  </script>
</body>
</html>
