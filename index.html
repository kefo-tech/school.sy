<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>school.sy</title>

  <style>
    :root{
      --bg:#f6f8ff; --ink:#0f172a; --muted:#64748b;
      --card:#ffffff; --line:rgba(15,23,42,.10);
      --shadow:0 10px 26px rgba(2,6,23,.10);
      --r:18px; --primary:#2563eb; --primary2:#06b6d4;
      --danger:#b91c1c; --ok:#16a34a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Noto Kufi Arabic","Noto Sans Arabic",sans-serif;
      background:
        radial-gradient(900px 500px at 15% 0%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(800px 450px at 85% 5%, rgba(6,182,212,.14), transparent 55%),
        linear-gradient(180deg,#eef7ff,var(--bg));
      color:var(--ink);
    }
    .hidden{ display:none !important; }
    .container{ max-width:1180px; margin:0 auto; padding:14px 14px 40px; }

    /* HERO */
    .hero{
      position:relative; border-radius:22px; overflow:hidden;
      border:1px solid rgba(255,255,255,.25); box-shadow:var(--shadow);
      min-height:220px;
      background:
        linear-gradient(135deg, rgba(37,99,235,.90), rgba(6,182,212,.80)),
        url("https://images.unsplash.com/photo-1523240795612-9a054b0db644?auto=format&fit=crop&w=1600&q=60");
      background-size:cover; background-position:center; isolation:isolate;
    }
    .hero::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(2,6,23,.05), rgba(2,6,23,.55)); z-index:0;}
    .heroInner{ position:relative; z-index:1; padding:20px 18px; display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; color:#fff; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:52px;height:52px;border-radius:16px; display:grid;place-items:center;
      background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.25);
      backdrop-filter:blur(10px); font-weight:1000; font-size:22px;
    }
    .heroTitle{ font-weight:1000; font-size:clamp(22px,3vw,34px); margin:0; line-height:1.15; }
    .heroSub{ margin-top:6px; opacity:.92; max-width:720px; line-height:1.6; }
    .heroBadges{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{
      padding:9px 12px; border-radius:999px;
      background:rgba(255,255,255,.16); border:1px solid rgba(255,255,255,.25);
      backdrop-filter:blur(10px); font-weight:900; font-size:13px; white-space:nowrap;
    }

    /* Sections */
    .section{ margin-top:18px; }
    .sectionHead{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin:18px 2px 10px; }
    .sectionHead h2{ margin:0; font-size:18px; font-weight:1000; }
    .hint{ color:var(--muted); font-size:13px; font-weight:800; }

    /* Top3 cards */
    .top3{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .topCard{
      background:rgba(255,255,255,.78); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:0 8px 20px rgba(2,6,23,.08); padding:12px;
      display:flex; gap:12px; align-items:center; min-height:88px;
      cursor:pointer;
    }
    .avatar{
      width:58px;height:58px;border-radius:50%; overflow:hidden;
      border:3px solid rgba(37,99,235,.18); background:#e2e8f0;
      flex:0 0 auto; display:grid; place-items:center;
      font-weight:1000; color:#0f172a;
    }
    .avatar img{ width:100%;height:100%;object-fit:cover; display:block; }
    .topMeta{ min-width:0; }
    .topName{ font-weight:1000; margin:0; font-size:15px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:240px; }
    .topVotes{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:900; }
    .rank{
      margin-inline-start:auto; font-weight:1000; color:#fff;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      border-radius:12px; padding:6px 10px; font-size:13px;
      box-shadow:0 10px 18px rgba(37,99,235,.18);
    }

    /* Filters */
    .filters{
      background:rgba(255,255,255,.78); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:0 8px 18px rgba(2,6,23,.06);
      padding:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .filters input, .filters select{
      border-radius:14px; border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.85);
      padding:10px 12px; outline:none; min-width:220px; font-weight:800;
    }
    .filters input:focus, .filters select:focus{
      border-color:rgba(37,99,235,.35);
      box-shadow:0 0 0 5px rgba(37,99,235,.12);
    }
    .count{ margin-inline-start:auto; color:var(--muted); font-size:13px; font-weight:1000; }

    /* Schools grid */
    .grid{ margin-top:12px; display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .card{
      background:rgba(255,255,255,.78); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:0 10px 24px rgba(2,6,23,.08); overflow:hidden;
      display:flex; flex-direction:column; min-height:320px;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .card:hover{ transform:translateY(-2px); box-shadow:0 18px 34px rgba(2,6,23,.12); }
    .cover{ height:140px; background:linear-gradient(135deg, rgba(37,99,235,.20), rgba(6,182,212,.18)); position:relative; overflow:hidden; }
    .cover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .cardBody{ padding:12px; display:flex; flex-direction:column; gap:8px; flex:1; }
    .schoolName{ margin:0; font-weight:1000; font-size:16px; line-height:1.25; }
    .schoolAddr{ color:var(--muted); font-size:13px; font-weight:800; line-height:1.6; min-height:42px; }
    .cardActions{ display:flex; gap:10px; margin-top:auto; padding-top:8px; flex-wrap:wrap; }
    .btn{
      cursor:pointer; border:1px solid transparent; border-radius:14px;
      padding:10px 12px; font-weight:1000; font-size:13px;
      background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#fff; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      box-shadow:0 10px 18px rgba(37,99,235,.14); flex:1 1 auto;
    }
    .btn.ghost{
      background:rgba(15,23,42,.04); color:var(--ink);
      border-color:rgba(15,23,42,.10); box-shadow:none;
    }

    /* School view */
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top: 14px;
    }
    .crumb{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color: var(--muted); font-weight: 900;
    }
    .crumb a{ color: var(--primary); text-decoration:none; font-weight:1000; }
    .schoolHero{
      margin-top: 10px;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.25);
      box-shadow: var(--shadow);
      background: #fff;
    }
    .schoolHeroCover{
      height: 210px;
      background: linear-gradient(135deg, rgba(37,99,235,.26), rgba(6,182,212,.20));
      position: relative;
      overflow:hidden;
    }
    .schoolHeroCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .schoolHeroBody{
      padding: 14px;
      display:flex;
      gap: 14px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .schoolLogo{
      width: 76px; height: 76px; border-radius: 22px;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(15,23,42,.10);
      display:grid; place-items:center;
      font-weight:1000;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .schoolLogo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .schoolMeta{ min-width:0; flex: 1 1 auto; }
    .schoolMeta h2{ margin:0; font-weight:1000; }
    .schoolMeta .sub{ margin-top:6px; color: var(--muted); font-weight:800; line-height:1.6; }
    .schoolMeta .addr{ margin-top:6px; color: var(--muted); font-weight:900; }

    /* Teacher/Students top in school page */
    .twocol{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .panel{
      background:rgba(255,255,255,.78); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:0 10px 22px rgba(2,6,23,.08);
      padding: 12px;
    }
    .panel h3{ margin:0 0 10px 0; font-weight:1000; font-size:16px; }
    .rankRow{
      display:flex; align-items:center; gap:10px;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.8);
      border-radius: 16px;
      padding: 10px;
      margin-top: 8px;
    }
    .rankRow .mini{
      width:44px;height:44px;border-radius:50%;
      display:grid;place-items:center; font-weight:1000;
      background: rgba(37,99,235,.10);
      border: 1px solid rgba(37,99,235,.18);
      overflow:hidden;
      flex: 0 0 auto;
    }
    .rankRow .mini img{ width:100%;height:100%;object-fit:cover; display:block; }
    .rankRow .name{ font-weight:1000; }
    .rankRow .votes{ color: var(--muted); font-weight:900; font-size:13px; }
    .rankRow .num{
      margin-inline-start:auto;
      font-weight:1000;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      border-radius: 12px;
      padding: 6px 10px;
      font-size: 13px;
    }

    /* Posts */
    .posts{ margin-top: 12px; }
    .post{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: 0 10px 22px rgba(2,6,23,.07);
      padding: 12px;
      margin-top: 10px;
    }
    .postHead{ display:flex; gap:10px; align-items:center; }
    .postHead .mini{ width:42px;height:42px;border-radius:50%; overflow:hidden; display:grid;place-items:center; font-weight:1000; background:#e2e8f0; }
    .postHead .mini img{ width:100%;height:100%;object-fit:cover; display:block; }
    .postTitle{ margin:0; font-weight:1000; }
    .postMeta{ margin-top:2px; color: var(--muted); font-weight:900; font-size:13px; }
    .postBody{ margin-top: 10px; line-height:1.7; font-weight: 800; color: #0b1220; }
    .bullets{ margin:8px 0 0; padding:0 18px; color:#0b1220; font-weight:800; }

    /* Modal */
    .backdrop{
      position:fixed; inset:0; background: rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      padding: 16px; z-index: 9999;
    }
    .backdrop.show{ display:flex; }
    .modal{
      width: min(560px, 100%);
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(255,255,255,.25);
      border-radius: 22px;
      box-shadow: 0 20px 55px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(15,23,42,.10);
    }
    .modalHead h4{ margin:0; font-weight:1000; }
    .modalBody{ padding: 12px 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ display:flex; flex-direction:column; gap:6px; margin-top: 10px; flex: 1 1 200px; }
    .field label{ color: var(--muted); font-weight: 1000; font-size: 13px; }
    .field input, .field select, .field textarea{
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      padding: 10px 12px;
      outline: none;
      font-weight: 900;
      width: 100%;
    }
    textarea{ min-height: 90px; resize: vertical; }
    .modalFoot{
      padding: 12px 14px;
      border-top: 1px solid rgba(15,23,42,.10);
      display:flex; gap: 10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .msg{ margin-top: 10px; font-weight: 1000; }
    .msg.ok{ color: var(--ok); }
    .msg.err{ color: var(--danger); }

    .footer{
      margin-top: 22px;
      padding: 16px 0 6px;
      color: var(--muted);
      font-weight: 900;
      font-size: 13px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap: wrap;
    }

    @media (max-width: 980px){
      .top3{ grid-template-columns: 1fr; }
      .grid{ grid-template-columns: repeat(2, 1fr); }
      .twocol{ grid-template-columns: 1fr; }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
      .filters input, .filters select{ min-width: 100%; }
      .count{ width:100%; margin-inline-start:0; }
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ============ HOME VIEW ============ -->
    <div id="viewHome">
      <section class="hero">
        <div class="heroInner">
          <div class="brand">
            <div class="logo">S</div>
            <div>
              <h1 class="heroTitle">school.sy</h1>
              <div class="heroSub">Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + ØµÙØ­Ø§Øª Ù…Ø¯Ø§Ø±Ø³ ØªÙØ§Ø¹Ù„ÙŠØ© (Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†/Ø§Ù„Ø·Ù„Ø§Ø¨ + Ù…Ù†Ø´ÙˆØ±Ø§Øª + Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª).</div>
            </div>
          </div>
          <div class="heroBadges">
            <div class="chip">ğŸ“ Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</div>
            <div class="chip">ğŸ† ØªÙˆØ¨ 3 Ù…Ø¯Ø§Ø±Ø³</div>
            <div class="chip">ğŸ—ºï¸ Ø®Ø±Ø§Ø¦Ø· Google</div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="sectionHead">
          <h2>ğŸ† Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Top 3)</h2>
          <div class="hint">Ø­Ø³Ø¨ votesCount Ø¯Ø§Ø®Ù„ ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ù…Ø¤Ù‚ØªÙ‹Ø§)</div>
        </div>
        <div class="top3" id="top3"></div>
      </section>

      <section class="section">
        <div class="sectionHead">
          <h2>ğŸ« Ù…Ø¯Ø§Ø±Ø³ Ø³ÙˆØ±ÙŠØ§</h2>
          <div class="hint">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</div>
        </div>

        <div class="filters">
          <input id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©..." />
          <select id="citySelect">
            <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>
          </select>
          <div class="count" id="countLabel">ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <div class="grid" id="schoolsGrid"></div>
      </section>

      <div class="footer">
        <span>school.sy Â©</span><span>â€¢</span><span>ØªØ·ÙˆÙŠØ±: Zakaria KeFo</span>
      </div>
    </div>

    <!-- ============ SCHOOL VIEW (SPA) ============ -->
    <div id="viewSchool" class="hidden">
      <div class="toolbar">
        <div class="crumb">
          <a href="#/">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          <span>â€¢</span>
          <span id="crumbSchool">â€”</span>
        </div>

        <div class="row">
          <a id="btnMaps" class="btn ghost" href="#" target="_blank" rel="noopener">ğŸ—ºï¸ Ø®Ø±Ø§Ø¦Ø· Google</a>
          <button id="btnRequestAccount" class="btn">Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨ (Ø·Ø§Ù„Ø¨/ÙˆÙ„ÙŠ Ø£Ù…Ø±)</button>
        </div>
      </div>

      <section class="schoolHero">
        <div class="schoolHeroCover" id="schoolCover"></div>
        <div class="schoolHeroBody">
          <div class="schoolLogo" id="schoolLogo">S</div>
          <div class="schoolMeta">
            <h2 id="schoolName">â€”</h2>
            <div class="sub" id="schoolDesc">â€”</div>
            <div class="addr" id="schoolAddr">â€”</div>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="sectionHead">
          <h2>â­ Ø§Ù„Ø£ÙØ¶Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h2>
          <div class="hint">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ leaderboards/{schoolId}</div>
        </div>

        <div class="twocol">
          <div class="panel">
            <h3>ğŸ… Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Top 3)</h3>
            <div id="topTeachers"></div>
          </div>
          <div class="panel">
            <h3>ğŸ… Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ (Top 3)</h3>
            <div id="topStudents"></div>
          </div>
        </div>
      </section>

      <section class="section posts">
        <div class="sectionHead">
          <h2>ğŸ“Œ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
          <div class="hint">Ù…Ù† collection: posts (Ù…Ø¹ schoolId)</div>
        </div>
        <div id="postsList"></div>
      </section>

      <div class="footer">
        <span>school.sy Â©</span><span>â€¢</span><span>ØªØ·ÙˆÙŠØ±: Zakaria KeFo</span>
      </div>
    </div>
  </div>

  <!-- ===== Modal: Account request (student/parent) ===== -->
  <div class="backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h4>Ø·Ù„Ø¨ Ø­Ø³Ø§Ø¨</h4>
        <button id="btnCloseModal" class="btn ghost" style="flex:0 0 auto; padding:8px 10px;">âœ–</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>Ø§Ù„Ø¯ÙˆØ±</label>
            <select id="reqRole">
              <option value="student">Ø·Ø§Ù„Ø¨</option>
              <option value="parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</option>
            </select>
          </div>

          <div class="field">
            <label id="labelName">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <input id="reqName" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." />
          </div>
        </div>

        <div class="field">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="reqNote" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©/Ø±Ù‚Ù… Ù„Ù„ØªÙˆØ§ØµÙ„..."></textarea>
        </div>

        <div id="reqMsg" class="msg"></div>
      </div>
      <div class="modalFoot">
        <button id="btnSendRequest" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      </div>
    </div>
  </div>

  <!-- =========================
       Firebase + SPA Logic
  ========================== -->
  <script type="module">
    /* ========= 0) Copy / right-click protection (best effort) ========= */
    (function(){
      document.addEventListener("contextmenu", e => e.preventDefault());
      document.addEventListener("dragstart", e => e.preventDefault());
      document.addEventListener("selectstart", e => e.preventDefault());
      document.addEventListener("copy", e => { e.preventDefault(); });
      document.addEventListener("cut", e => { e.preventDefault(); });
      document.addEventListener("keydown", (e) => {
        const k = (e.key||"").toLowerCase();
        // Ù…Ù†Ø¹ Ø£ÙƒØ«Ø± Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø´ÙŠÙˆØ¹Ù‹Ø§
        if ((e.ctrlKey || e.metaKey) && ["c","x","u","s","p","a"].includes(k)) e.preventDefault();
        if (e.key === "PrintScreen") e.preventDefault();
      });

      // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†
      let t = null;
      document.addEventListener("touchstart", () => { t = setTimeout(()=>{}, 500); }, {passive:true});
      document.addEventListener("touchend", () => { if(t) clearTimeout(t); t=null; }, {passive:true});
    })();

    /* ========= 1) Firebase config ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyCexRHqxd8Xm_EBWMEnLj_2WAjxJcgXf9g",
      authDomain: "school-sy.firebaseapp.com",
      projectId: "school-sy",
      storageBucket: "school-sy.firebasestorage.app",
      messagingSenderId: "121186119852",
      appId: "1:121186119852:web:f96d12deade6cebbda6f09"
    };

    /* ========= 2) Firebase imports (CDN) ========= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      addDoc,
      onSnapshot,
      query,
      where,
      orderBy,
      limit,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ========= 3) DOM helpers ========= */
    const $ = (id) => document.getElementById(id);
    const esc = (s) => String(s||"").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
    const slugify = (s) => (s||"")
      .toString().trim().toLowerCase()
      .replace(/\s+/g,"-")
      .replace(/[^\w\u0600-\u06FF-]+/g,"")
      .replace(/-+/g,"-")
      .slice(0,60);

    /* ========= 4) Views ========= */
    const viewHome = $("viewHome");
    const viewSchool = $("viewSchool");
    const top3El = $("top3");
    const gridEl = $("schoolsGrid");
    const searchBox = $("searchBox");
    const citySelect = $("citySelect");
    const countLabel = $("countLabel");

    // School view elements
    const crumbSchool = $("crumbSchool");
    const schoolCover = $("schoolCover");
    const schoolLogo = $("schoolLogo");
    const schoolName = $("schoolName");
    const schoolDesc = $("schoolDesc");
    const schoolAddr = $("schoolAddr");
    const btnMaps = $("btnMaps");
    const topTeachers = $("topTeachers");
    const topStudents = $("topStudents");
    const postsList = $("postsList");

    /* ========= 5) State ========= */
    let allSchools = [];
    let topSchools = [];
    let unsubSchool = null;
    let unsubBoards = null;
    let unsubPosts = null;
    let currentSchoolId = null;
    let currentSchool = null;

    function showHome(){
      viewHome.classList.remove("hidden");
      viewSchool.classList.add("hidden");
      document.title = "school.sy";
      cleanupSchoolListeners();
    }

    function showSchool(){
      viewHome.classList.add("hidden");
      viewSchool.classList.remove("hidden");
    }

    function cleanupSchoolListeners(){
      if (typeof unsubSchool === "function") unsubSchool();
      if (typeof unsubBoards === "function") unsubBoards();
      if (typeof unsubPosts === "function") unsubPosts();
      unsubSchool = unsubBoards = unsubPosts = null;
      currentSchoolId = null;
      currentSchool = null;
    }

    /* ========= 6) Home render ========= */
    function mapsLink(s){
      if (s.mapsUrl) return s.mapsUrl;
      const q = encodeURIComponent(`${s.name||""} ${s.city||""} ${s.address||""}`.trim());
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    function schoolHash(s){
      const slug = slugify(s.name);
      return `#/school/${encodeURIComponent(s.id)}-${encodeURIComponent(slug)}`;
    }

    function renderTop3(){
      top3El.innerHTML = "";
      const arr = topSchools.slice(0, 3);

      for (let i=0;i<3;i++){
        const s = arr[i] || { name:"â€”", votesCount:0, logoURL:"" };
        const el = document.createElement("div");
        el.className = "topCard";
        el.innerHTML = `
          <div class="avatar">
            ${s.logoURL ? `<img src="${esc(s.logoURL)}" alt="">` : (esc(s.name)[0] || "ØŸ")}
          </div>
          <div class="topMeta">
            <p class="topName">${esc(s.name || "â€”")}</p>
            <div class="topVotes">Ø§Ù„ØªØµÙˆÙŠØª: ${Number(s.votesCount || 0)}</div>
          </div>
          <div class="rank">#${i+1}</div>
        `;
        el.addEventListener("click", () => { location.hash = schoolHash(s); });
        top3El.appendChild(el);
      }
    }

    function fillCities(){
      const cities = Array.from(new Set(allSchools.map(s => (s.city || "").trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b,'ar'));
      const current = citySelect.value;
      citySelect.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„Ù…Ø¯Ù†</option>` + cities.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("");
      citySelect.value = current;
    }

    function renderSchools(list){
      gridEl.innerHTML = "";
      if (!list.length){
        gridEl.innerHTML = `<div style="grid-column:1/-1;color:#64748b;font-weight:1000;padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>`;
        return;
      }

      for (const s of list){
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="cover">
            ${s.coverURL ? `<img src="${esc(s.coverURL)}" alt="">` : ``}
          </div>
          <div class="cardBody">
            <h3 class="schoolName">${esc(s.name || "Ù…Ø¯Ø±Ø³Ø©")}</h3>
            <div class="schoolAddr">
              <div>ğŸ“ ${esc(s.city || "â€”")}</div>
              <div>${esc(s.address || "")}</div>
            </div>

            <div class="cardActions">
              <a class="btn ghost" href="${esc(mapsLink(s))}" target="_blank" rel="noopener">ğŸ—ºï¸ Ø®Ø±Ø§Ø¦Ø· Google</a>
              <a class="btn" href="${esc(schoolHash(s))}">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</a>
            </div>
          </div>
        `;
        gridEl.appendChild(el);
      }
    }

    function applyFilters(){
      const q = (searchBox.value || "").trim().toLowerCase();
      const city = (citySelect.value || "").trim();

      const filtered = allSchools.filter(s => {
        const okCity = !city || (s.city || "").trim() === city;
        const okQ = !q || (s.name || "").toLowerCase().includes(q) || (s.address || "").toLowerCase().includes(q);
        return okCity && okQ;
      });

      renderSchools(filtered);
      countLabel.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${filtered.length}`;
    }

    searchBox.addEventListener("input", applyFilters);
    citySelect.addEventListener("change", applyFilters);

    /* ========= 7) School view render ========= */
    function renderRank(container, arr){
      container.innerHTML = "";
      const safe = Array.isArray(arr) ? arr : [];
      for(let i=0;i<3;i++){
        const it = safe[i] || { displayName:"â€”", count:0, photoURL:"" };
        const row = document.createElement("div");
        row.className = "rankRow";
        row.innerHTML = `
          <div class="mini">${it.photoURL ? `<img src="${esc(it.photoURL)}" alt="">` : (esc(it.displayName)[0] || "ØŸ")}</div>
          <div>
            <div class="name">${esc(it.displayName || "â€”")}</div>
            <div class="votes">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµÙˆÙ‘ØªÙŠÙ†: ${Number(it.count||0)}</div>
          </div>
          <div class="num">#${i+1}</div>
        `;
        container.appendChild(row);
      }
    }

    function renderPosts(items){
      postsList.innerHTML = "";
      if (!items.length){
        postsList.innerHTML = `<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¹Ø¯.</div>`;
        return;
      }

      for (const p of items){
        const box = document.createElement("div");
        box.className = "post";

        const typeLabel = p.type === "mcq" ? "Ø§Ø®ØªØ¨Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯)" : "Ù…Ù†Ø´ÙˆØ±";
        const authorName = p.authorName || "Ù…Ø¹Ù„Ù…/Ø¥Ø¯Ø§Ø±Ø©";

        let body = "";
        if (p.type === "mcq"){
          const opts = (p.mcq?.options || []).map(x => `<li>${esc(x)}</li>`).join("");
          body = `
            <div class="postBody">
              <div style="font-weight:1000">Ø³Ø¤Ø§Ù„:</div>
              <div style="margin-top:6px">${esc(p.mcq?.question || "")}</div>
              <ul class="bullets">${opts}</ul>
            </div>
          `;
        } else {
          body = `<div class="postBody">${esc(p.content || "")}</div>`;
        }

        box.innerHTML = `
          <div class="postHead">
            <div class="mini">${p.authorPhoto ? `<img src="${esc(p.authorPhoto)}" alt="">` : (esc(authorName)[0] || "Ù…")}</div>
            <div style="min-width:0">
              <p class="postTitle">${esc(p.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†")}</p>
              <div class="postMeta">${esc(typeLabel)} â€¢ ${esc(authorName)}</div>
            </div>
          </div>
          ${body}
        `;
        postsList.appendChild(box);
      }
    }

    async function loadSchool(schoolId){
      cleanupSchoolListeners();
      currentSchoolId = schoolId;
      showSchool();

      // 1) School doc
      unsubSchool = onSnapshot(doc(db, "schools", schoolId), (snap) => {
        if (!snap.exists()){
          crumbSchool.textContent = "Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
          schoolName.textContent = "Ù…Ø¯Ø±Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©";
          schoolDesc.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.";
          schoolAddr.textContent = "";
          btnMaps.href = "#/";
          return;
        }

        currentSchool = { id: snap.id, ...(snap.data()||{}) };

        const nm = currentSchool.name || "Ù…Ø¯Ø±Ø³Ø©";
        crumbSchool.textContent = nm;
        document.title = `${nm} â€” school.sy`;

        // cover
        if (currentSchool.coverURL){
          schoolCover.innerHTML = `<img src="${esc(currentSchool.coverURL)}" alt="">`;
        } else {
          schoolCover.innerHTML = "";
        }

        // logo
        if (currentSchool.logoURL){
          schoolLogo.innerHTML = `<img src="${esc(currentSchool.logoURL)}" alt="">`;
        } else {
          schoolLogo.textContent = (nm[0] || "S");
        }

        schoolName.textContent = nm;
        schoolDesc.textContent = currentSchool.description || "ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†/Ø§Ù„Ø·Ù„Ø§Ø¨ + Ù…Ù†Ø´ÙˆØ±Ø§Øª + Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.";
        schoolAddr.textContent = `ğŸ“ ${currentSchool.city || "â€”"} â€¢ ${currentSchool.address || ""}`;

        btnMaps.href = (currentSchool.mapsUrl) ? currentSchool.mapsUrl : mapsLink(currentSchool);
      });

      // 2) Leaderboards doc (per school)
      unsubBoards = onSnapshot(doc(db, "leaderboards", schoolId), (snap) => {
        const d = snap.data() || {};
        renderRank(topTeachers, d.teachersTop || []);
        renderRank(topStudents, d.studentsTop || []);
      });

      // 3) Posts (where schoolId)
      // Ù‚Ø¯ ÙŠØ·Ù„Ø¨ Firestore Index Ø£ÙˆÙ„ Ù…Ø±Ø© â€” Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø®Ø·Ø£ indexØŒ Ø³Ø£Ø¹Ø·ÙŠÙƒ Ø®Ø·ÙˆØ© Ø¥Ù†Ø´Ø§Ø¡Ù‡.
      const qPosts = query(
        collection(db, "posts"),
        where("schoolId", "==", schoolId),
        orderBy("createdAt", "desc"),
        limit(30)
      );

      unsubPosts = onSnapshot(qPosts, (snap) => {
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...(d.data()||{}) }));
        renderPosts(arr);
      }, (err) => {
        console.error(err);
        postsList.innerHTML = `<div class="msg err">âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª. Ø¥Ø°Ø§ Ø¸Ù‡Ø± Ø®Ø·Ø£ Index Ø£Ø®Ø¨Ø±Ù†ÙŠ ÙˆØ³Ø£Ø¹Ø·ÙŠÙƒ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø¥Ù†Ø´Ø§Ø¡Ù‡.</div>`;
      });
    }

    /* ========= 8) Routing (Hash) ========= */
    function parseRoute(){
      const h = (location.hash || "#/").replace(/^#/, "");
      if (h === "/" || h === "") return { view:"home" };

      const m = h.match(/^\/school\/([^\/]+)$/);
      if (m){
        // format: <id>-<slug>
        const raw = decodeURIComponent(m[1]);
        const id = raw.split("-")[0]; // Ù†Ø£Ø®Ø° id Ù‚Ø¨Ù„ Ø£ÙˆÙ„ "-"
        return { view:"school", schoolId:id };
      }
      return { view:"home" };
    }

    async function route(){
      const r = parseRoute();
      if (r.view === "home"){
        showHome();
      } else {
        await loadSchool(r.schoolId);
      }
    }
    window.addEventListener("hashchange", route);

    /* ========= 9) Modal: student/parent request ========= */
    const modalBackdrop = $("modalBackdrop");
    const btnCloseModal = $("btnCloseModal");
    const btnRequestAccount = $("btnRequestAccount");
    const btnSendRequest = $("btnSendRequest");
    const reqRole = $("reqRole");
    const reqName = $("reqName");
    const reqNote = $("reqNote");
    const reqMsg = $("reqMsg");
    const labelName = $("labelName");

    function openModal(){
      reqMsg.textContent = "";
      reqMsg.className = "msg";
      reqRole.value = "student";
      reqName.value = "";
      reqNote.value = "";
      labelName.textContent = "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨";
      modalBackdrop.classList.add("show");
      modalBackdrop.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modalBackdrop.classList.remove("show");
      modalBackdrop.setAttribute("aria-hidden","true");
    }

    btnRequestAccount.addEventListener("click", () => {
      if (!currentSchoolId) return;
      openModal();
    });
    btnCloseModal.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });

    reqRole.addEventListener("change", () => {
      labelName.textContent = (reqRole.value === "parent") ? "Ø£Ù‡Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" : "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨";
    });

    btnSendRequest.addEventListener("click", async () => {
      reqMsg.textContent = "";
      reqMsg.className = "msg";

      if (!currentSchoolId){
        reqMsg.textContent = "Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.";
        reqMsg.classList.add("err");
        return;
      }

      const role = reqRole.value;
      const name = (reqName.value || "").trim();
      const note = (reqNote.value || "").trim();

      if (!name){
        reqMsg.textContent = "Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨";
        reqMsg.classList.add("err");
        return;
      }

      try{
        await addDoc(collection(db, "account_requests"), {
          schoolId: currentSchoolId,
          role: role, // student | parent
          displayName: name,
          note: note,
          status: "pending",
          createdAt: serverTimestamp()
        });

        reqMsg.textContent = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.";
        reqMsg.classList.add("ok");
        setTimeout(closeModal, 900);
      }catch(e){
        console.error(e);
        reqMsg.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ØªØ­Ù‚Ù‚ Ù…Ù† Rules).";
        reqMsg.classList.add("err");
      }
    });

    /* ========= 10) Schools list listener ========= */
    // Ù†Ù‚Ø±Ø£ ÙƒÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø«Ù… Ù†ÙÙ„ØªØ± Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø¨Ø³ÙŠØ· ÙˆØ³Ø±ÙŠØ¹ Ù„Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø£ÙˆÙ„Ù‰)
    // fields Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©: name, city, address, logoURL, coverURL, mapsUrl, votesCount, description
    const qSchools = query(collection(db, "schools"), orderBy("name"), limit(800));

    onSnapshot(qSchools, (snap) => {
      const arr = [];
      snap.forEach(docu => {
        const d = docu.data() || {};
        arr.push({
          id: docu.id,
          name: d.name || "",
          city: d.city || "",
          address: d.address || "",
          logoURL: d.logoURL || "",
          coverURL: d.coverURL || "",
          mapsUrl: d.mapsUrl || "",
          votesCount: Number(d.votesCount || 0),
          description: d.description || ""
        });
      });

      allSchools = arr;
      topSchools = [...allSchools].sort((a,b) => (b.votesCount||0) - (a.votesCount||0));

      renderTop3();
      fillCities();
      applyFilters();
      if (!countLabel.textContent || countLabel.textContent === "ØªØ­Ù…ÙŠÙ„...") countLabel.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${allSchools.length}`;
    });

    /* ========= 11) Start ========= */
    route();
  </script>
</body>
</html>
